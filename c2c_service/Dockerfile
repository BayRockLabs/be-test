FROM python:3.11.9-slim-bullseye

# Define ARG variables
ARG DEBUG
ARG MONTHLY
ARG YEARLY
ARG BI_WEEKLY
ARG QUARTERLY
ARG ACTIVE
ARG INACTIVE
ARG POTENTIAL_LEAD
ARG ONBOARDED
ARG US
ARG LATAM
ARG IND
ARG EUR
ARG USD
ARG INR
ARG EMPLOYEE
ARG CONTRACTOR
ARG EMPLOYEE_HOURLY
ARG SUB_CONTRACTOR
ARG ACCOUNT_URL
ARG AZURE_CONTAINER_NAME
ARG AZURE_CONNECTION_STRING
ARG DB_HOSTNAME
ARG DB_USERNAME
ARG DB_PASSWORD
ARG DB_NAME
ARG DB_PORT
ARG AUTH_API
ARG PROFILE
ARG MPS_DOCUMENT_PARSER_API
ARG OPENAI_API
ARG SCHEDULER_DAY
ARG SCHEDULER_HOUR
ARG SCHEDULER_MINUTE
ARG SCHEDULER_TIMEZONE

# Convert ARG to ENV
ENV DEBUG=$DEBUG
ENV MONTHLY=$MONTHLY
ENV YEARLY=$YEARLY
ENV BI_WEEKLY=$BI_WEEKLY
ENV QUARTERLY=$QUARTERLY
ENV ACTIVE=$ACTIVE
ENV INACTIVE=$INACTIVE
ENV POTENTIAL_LEAD=$POTENTIAL_LEAD
ENV ONBOARDED=$ONBOARDED
ENV US=$US
ENV LATAM=$LATAM
ENV IND=$IND
ENV EUR=$EUR
ENV USD=$USD
ENV INR=$INR
ENV EMPLOYEE=$EMPLOYEE
ENV CONTRACTOR=$CONTRACTOR
ENV EMPLOYEE_HOURLY=$EMPLOYEE_HOURLY
ENV SUB_CONTRACTOR=$SUB_CONTRACTOR
ENV ACCOUNT_URL=$ACCOUNT_URL
ENV AZURE_CONTAINER_NAME=$AZURE_CONTAINER_NAME
ENV AZURE_CONNECTION_STRING=$AZURE_CONNECTION_STRING
ENV DB_HOSTNAME=$DB_HOSTNAME
ENV DB_USERNAME=$DB_USERNAME
ENV DB_PASSWORD=$DB_PASSWORD
ENV DB_NAME=$DB_NAME
ENV DB_PORT=$DB_PORT
ENV AUTH_API=$AUTH_API
ENV PROFILE=$PROFILE
ENV MPS_DOCUMENT_PARSER_API=$MPS_DOCUMENT_PARSER_API
ENV OPENAI_API=$OPENAI_API
ENV SCHEDULER_DAY=$SCHEDULER_DAY
ENV SCHEDULER_HOUR=$SCHEDULER_HOUR
ENV SCHEDULER_MINUTE=$SCHEDULER_MINUTE
ENV SCHEDULER_TIMEZONE=$SCHEDULER_TIMEZONE

WORKDIR /app

COPY . /app/
COPY tika-server-standard-2.6.0.jar /tmp/tika-server.jar

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        openjdk-11-jre

RUN java --version

RUN pip install -r requirements.txt && chmod a+x /app/entrypoint.sh

# Convert line endings using sed
RUN sed -i 's/\r$//' /app/entrypoint.sh

# Expose port 8000
EXPOSE 8000

# Start Tika server and Python app
CMD ["bash", "-c", "/app/entrypoint.sh"]